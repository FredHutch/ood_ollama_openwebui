#!/usr/bin/env bash
module purge

# load RStudio Server # uv
module load Apptainer uv

# Output debug info
module list



  

echo port is $port
echo host is $host

echo
echo NOT USING THESE now:
echo webui_port is $webui_port
echo ollama_port is $ollama_port
echo ------


# excerpt from https://discourse.openondemand.org/t/avoid-launching-a-web-browser/4060/14?u=dtenenba


<%

nv = ""
if context.want_gpu == "1"
  nv = " --nv "
end


%>


set -x
set -e

export OLLAMA_HOST=${host}:11434
export OLLAMA_MODELS=/app/ollama/models
apptainer run  <%= nv %>  --env OLLAMA_HOST=${host}:11434 -B /app/ollama/models:/app/ollama/models:ro --writable-tmpfs --env OLLAMA_MODELS=${OLLAMA_MODELS} https://sif-registry.fredhutch.org/ollama_latest.sif  serve &
mkdir openwebui # maybe the next line is a typo?
mkdir openwebui. # this is where the database shows up, and is per-instance
mkdir conf
mkdir client_temp
mkdir var_run
# TODO removing --env-file env_file for now
# TODO removing --overlay openwebui for now
mkdir -p ~/.openwebui
apptainer run -B ~/.openwebui:/app/backend/data:rw https://sif-registry.fredhutch.org/open-webui_v0.5.18.sif  &
apptainer run --writable-tmpfs \
     --env FORWARD_PORT=${port} \
     --env FORWARD_HOST=${host} \
     -B ./templates:/etc/nginx/templates \
     -B ./:/var/log/nginx/ \
     -B ./conf:/etc/nginx/conf.d/ \
     -B ./client_temp:/var/cache/nginx/client_temp/ \
     -B ./var_run:/var/run/ \
     --app docker \
     https://sif-registry.fredhutch.org/nginx_1.26.3.sif nginx

